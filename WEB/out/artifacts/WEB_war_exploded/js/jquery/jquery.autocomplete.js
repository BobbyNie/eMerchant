(function(A){A.fn.extend({autocomplete:function(B,D){var C=typeof B=="string";D=A.extend({},A.Autocompleter.defaults,{url:C?B:null,data:C?null:B,delay:C?A.Autocompleter.defaults.delay:10,max:D&&!D.scroll?10:150},D);D.highlight=D.highlight||function(E){return E};D.formatMatch=D.formatMatch||D.formatItem;return this.each(function(){new A.Autocompleter(this,D)})},result:function(B){return this.bind("result",B)},search:function(B){return this.trigger("search",[B])},flushCache:function(){return this.trigger("flushCache")},setOptions:function(B){return this.trigger("setOptions",[B])},unautocomplete:function(){return this.trigger("unautocomplete")}});A.Autocompleter=function(S,M){var X={UP:38,DOWN:40,DEL:46,TAB:9,RETURN:13,ESC:27,COMMA:188,PAGEUP:33,PAGEDOWN:34,BACKSPACE:8};var I=A(S).attr("autocomplete","off").addClass(M.inputClass);var P;var B="";var T=A.Autocompleter.Cache(M);var K=0;var N;var E={mouseDownOnSelect:false};var R=A.Autocompleter.Select(M,S,J,E);var Q;A.browser.opera&&A(S.form).bind("submit.autocomplete",function(){if(Q){Q=false;return false}});I.bind({"keydown.autocomplete":function(Y){K=1;N=Y.keyCode;switch(Y.keyCode){case X.UP:Y.preventDefault();if(R.visible()){R.prev()}else{W(0,true)}break;case X.DOWN:Y.preventDefault();if(R.visible()){R.next()}else{W(0,true)}break;case X.PAGEUP:Y.preventDefault();if(R.visible()){R.pageUp()}else{W(0,true)}break;case X.PAGEDOWN:Y.preventDefault();if(R.visible()){R.pageDown()}else{W(0,true)}break;case M.multiple&&A.trim(M.multipleSeparator)==","&&X.COMMA:case X.TAB:case X.RETURN:if(J()){Y.preventDefault();Q=true;return false}break;case X.ESC:R.hide();break;default:clearTimeout(P);P=setTimeout(W,M.delay);break}},"focus.autocomplete":function(){K++},"blur.autocomplete":function(){K=0;if(!E.mouseDownOnSelect){F()}else{I.focus();E.mouseDownOnSelect=false}},"click.autocomplete":function(){},"search.autocomplete":function(){var Y=(arguments.length>1)?arguments[1]:null;function Z(d,b){var a;if(b&&b.length){for(var c=0;c<b.length;c++){if(b[c].result.toLowerCase()==d.toLowerCase()){a=b[c];break}}}if(typeof Y=="function"){Y(a)}else{I.trigger("result",a&&[a.data,a.value])}}A.each(C(I.val()),function(b,a){V(a,Z,Z)})},"flushCache.autocomplete":function(){T.flush()},"setOptions.autocomplete":function(){A.extend(M,arguments[1]);if("data" in arguments[1]){T.populate()}},"unautocomplete.autocomplete":function(){R.unbind();I.unbind(".autocomplete");A(S.form).unbind(".autocomplete")},"input.autocomplete":function(){W(0,true)}});function J(){var e=R.selected();if(!e){return false}var b=e.result;B=b;if(typeof(M.afterSelect)=="function"){M.inSelect=true;M.afterSelect(e.data)}if(M.multiple){var c=C(I.val());if(c.length>1){var Z=M.multipleSeparator.length;var d=A(S).selection().start;var a,Y=0;A.each(c,function(f,g){Y+=g.length;if(d<=Y){a=f;return false}Y+=Z});c[a]=b;b=c.join(M.multipleSeparator)}b+=M.multipleSeparator}I.val(b);G();I.trigger("result",[e.data,e.value]);return true}function W(Y,Z){if(N==X.DEL){R.hide();return}var a=I.val();if(!Z&&a==B){return}B=a;a=L(a);if(a.length>=M.minChars){I.addClass(M.loadingClass);if(!M.matchCase){a=a.toLowerCase()}V(a,O,G)}else{U();R.hide()}}function C(Y){if(!Y){return[""]}if(!M.multiple){return[A.trim(Y)]}return A.map(Y.split(M.multipleSeparator),function(Z){return A.trim(Y).length?A.trim(Z):null})}function L(Y){if(!M.multiple){return Y}var Z=C(Y);if(Z.length==1){return Z[0]}var a=A(S).selection().start;if(a==Y.length){Z=C(Y)}else{Z=C(Y.replace(Y.substring(a),""))}return Z[Z.length-1]}function D(Z,Y){if(M.autoFill&&(L(I.val()).toLowerCase()==Z.toLowerCase())&&N!=X.BACKSPACE){I.val(I.val()+Y.substring(L(B).length));A(S).selection(B.length,B.length+Y.length)}}function F(){clearTimeout(P);P=setTimeout(G,200)}function G(){var Y=R.visible();R.hide();clearTimeout(P);U();if(M.mustMatch){I.search(function(Z){if(!Z){if(M.multiple){var a=C(I.val()).slice(0,-1);I.val(a.join(M.multipleSeparator)+(a.length?M.multipleSeparator:""))}else{I.val("");I.trigger("result",null)}}})}}function O(Z,Y){if(Y&&Y.length&&K){U();R.display(Y,Z);if(A.browser.msie){D(Z,Y[0].value)}R.show()}else{G()}}function V(d,Y,Z){var e="jquery.autocomplete.js->request()";if(!M.matchCase){d=d.toLowerCase()}var c=T.load(d);if(c&&c.length){Y(d,c)}else{if((typeof M.url=="string")&&(M.url.length>0)){var b={timestamp:+new Date()};var a=M.requestName||"value";var f={limit:M.max};f[a]=L(d);A.each(M.extraParams,function(g,h){b[g]=typeof h=="function"?h():h});A.ajax({mode:"abort",port:"autocomplete"+S.name,type:"POST",async:false,cache:false,global:false,dataType:"json",url:M.url,data:A.extend(f,b),success:function(h){ctp.core.log.obj(e,"Request successfully.Response data:",h);var g=M.parse&&M.parse(h)||H(h);T.add(d,g);Y(d,g)},error:function(h,g,i){ctp.core.log.warning(e,"Response error textStatus:"+g);ctp.core.log.obj(e,"Response errorThrown:",i);ctp.core.log.warning(e,"The detail error response text:"+h.responseText)}})}else{R.emptyList();Z(d)}}}function H(d){var b=[];var c=d;for(var a=0;a<c.length;a++){var Z=c[a];if(Z){var Y=Z[M.valueField]||Z[M.textField];b[b.length]={data:Z,value:Y,result:M.formatResult&&M.formatResult(Z,Y)||Y}}}return b}function U(){I.removeClass(M.loadingClass)}};A.Autocompleter.defaults={inputClass:"ctp-textfield-input",resultsClass:"ctp-textfield-results ctp-fs",loadingClass:"ctp-textfield-loading",minChars:1,delay:400,matchCase:false,matchSubset:true,matchContains:false,cacheLength:10,reasultSearch:null,max:100,mustMatch:false,extraParams:{},selectFirst:true,formatItem:function(B){return B[0]},formatMatch:null,autoFill:false,width:0,multiple:false,multipleSeparator:", ",highlight:function(B,C){return B.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+C.replace(/([\^\$\(\)\[\]\{\}\*\.\+\?\|\\])/gi,"\\$1")+")(?![^<>]*>)(?![^&;]+;)","gi"),"<strong>$1</strong>")},scroll:true,scrollHeight:180};A.Autocompleter.Cache=function(B){var E={};var G=0;var F=new Array();function C(K,J){if(typeof K!="string"){return false}if(!B.matchCase){K=K.toString().toLowerCase()}var L=K.indexOf(J);if(B.matchContains=="word"){L=K.toLowerCase().search("\\b"+J.toLowerCase())}if(L==-1){return false}return L==0||B.matchContains}function D(K,J){if(G>B.cacheLength){I()}if(!E[K]){G++}E[K]=J}function H(){if(!B.data){return false}var M={},O=0;if(!B.url){B.cacheLength=1}M[""]=[];for(var J=0,K=B.data.length;J<K;J++){var Q=B.data[J];Q=(typeof Q=="string")?[Q]:Q;var L=B.formatMatch(Q,J+1,B.data.length);if(L===false){continue}var P=L.charAt(0).toLowerCase();if(!M[P]){M[P]=[]}var N={value:L,data:Q,result:B.formatResult&&B.formatResult(Q)||L};M[P].push(N);F.push(N);if(O++<B.max){M[""].push(N)}}A.each(M,function(S,R){B.cacheLength++;D(S,R)})}setTimeout(H,25);function I(){E={};G=0}return{flush:I,add:D,populate:H,load:function(N){if(!B.cacheLength||!G){return null}if(!B.url&&B.matchContains){var J=[];for(var M in E){if(M.length>0){var K=E[M];A.each(K,function(P,O){if(C(O.value,N)){J.push(O)}})}}return J}else{if(typeof(B.reasultSearch)=="function"){var J=[];A.each(F,function(P,Q){var O=B.reasultSearch(Q,N);if(O!=null&&O!=false){J.push(O)}});return J}else{if(E[N]){return E[N]}else{if(B.matchSubset){for(var L=N.length-1;L>=B.minChars;L--){var K=E[N.substr(0,L)];if(K){var J=[];A.each(K,function(P,O){if(C(O.value,N)){J[J.length]=O}});return J}}}}}}return null}}};A.Autocompleter.Select=function(G,R,Q,C){var L={ACTIVE:"ctp-textfield-over"};var K,F=-1,E,T="",D=true,J,P;var N="";function O(U){if(!D){return}J=A("<div/>").hide().addClass(G.resultsClass).css("position","absolute").appendTo(document.body);N=U;P=A("<ul/>").appendTo(J).mouseover(function(X){if(S(X).nodeName&&S(X).nodeName.toUpperCase()=="LI"){F=A("li",P).removeClass(L.ACTIVE).index(S(X));var V=A(S(X));V.addClass(L.ACTIVE);if(G.autoFill==true){var Y=R.id;var W=A("#"+Y);var Z=V.data("ctp-textfield-data").value;W.val(Z);W.selection(U.length,Z.length)}}}).click(function(W){A(S(W)).addClass(L.ACTIVE);Q();var X=R.id;var V=A("#"+X);V.selection(V.val().length,V.val().length);R.focus();return false}).mousedown(function(){C.mouseDownOnSelect=true}).mouseup(function(){C.mouseDownOnSelect=false});if(G.width>0){J.css("width",G.width)}D=false}function S(U){var V=U.target;while(V&&V.tagName!="LI"){V=V.parentNode}if(!V){return[]}return V}function H(U){K.slice(F,F+1).removeClass(L.ACTIVE);I(U);var W=K.slice(F,F+1).addClass(L.ACTIVE);if(G.scroll){var Z=0;K.slice(0,F).each(function(){Z+=this.offsetHeight});if((Z+W[0].offsetHeight-P.scrollTop())>P[0].clientHeight){P.scrollTop(Z+W[0].offsetHeight-P.innerHeight())}else{if(Z<P.scrollTop()){P.scrollTop(Z)}}}if(G.autoFill==true){var X=R.id;var V=A("#"+X);var Y=W.data("ctp-textfield-data").value;V.val(Y);V.selection(N.length,Y.length)}}function I(U){F+=U;if(F<0){F=K.size()-1}else{if(F>=K.size()){F=0}}}function B(U){return G.max&&G.max<U?G.max:U}function M(){P.empty();var Y=B(E.length);for(var X=0;X<Y;X++){if(!E[X]){continue}var U=G.formatItem(E[X].data,X+1,Y,E[X].value,T);if(U===false){continue}var V=A("<li/>").html(G.highlight(U,T)).attr("title",U).addClass(X%2==0?"ctp-textfield-even":"ctp-textfield-odd").appendTo(P)[0];A.data(V,"ctp-textfield-data",E[X])}if(G.showStat&&E.length>Y){var W=">>"+"Total matched ".local()+"("+E.length+")"+" record,there is ".local()+"("+(E.length-Y)+")"+" record can display".local()+".";A('<li class="ctp-textfield-even" title="'+W+'">'+W+"</li>").appendTo(P)}K=P.find("li");if(G.selectFirst){K.slice(0,1).addClass(L.ACTIVE);F=0}if(A.fn.bgiframe){}}return{display:function(U,V){O(V);E=U;T=V;M()},next:function(){H(1)},prev:function(){H(-1)},pageUp:function(){if(F!=0&&F-8<0){H(-F)}else{H(-8)}},pageDown:function(){if(F!=K.size()-1&&F+8>K.size()){H(K.size()-1-F)}else{H(8)}},hide:function(){J&&J.hide();K&&K.removeClass(L.ACTIVE);F=-1},visible:function(){return J&&J.is(":visible")},current:function(){return this.visible()&&(K.filter("."+L.ACTIVE)[0]||G.selectFirst&&K[0])},selectFirst:function(){F=0;H(0)},show:function(){var X=A(R).offset();var U=A(document).height();J.css({width:typeof G.width=="string"||G.width>0?G.width:A(R).width()+3,top:X.top+R.offsetHeight,left:X.left}).show();if(G.scroll){P.scrollTop(0);P.css({maxHeight:G.scrollHeight,overflow:"auto"});P.height()>G.scrollHeight?P.height(G.scrollHeight):"";var W=0;var V=0;K.each(function(){W+=this.offsetHeight;if(A(this).width()>V){V=A(this).width()}});P.width()>V?K.width(P.width()-10):K.width(V);if(A.browser.msie&&A.browser.version>6){var Y=W>G.scrollHeight;P.css("height",Y?G.scrollHeight:W+6);if(!Y){}}if(!G.scrollAddition&&A.browser.version<7){P.height(P.height()+17);G.scrollAddition=true}if(X.top+R.offsetHeight+P.height()>U){J.css({top:X.top-P.height()})}}},selected:function(){var U=K&&K.filter("."+L.ACTIVE).removeClass(L.ACTIVE);return U&&U.length&&A.data(U[0],"ctp-textfield-data")},emptyList:function(){P&&P.empty()},unbind:function(){J&&J.remove()}}};A.fn.selection=function(G,C){if(G!==undefined){return this.each(function(){if(this.createTextRange){var J=this.createTextRange();if(C===undefined||G==C){J.move("character",G);J.select()}else{J.collapse(true);J.moveStart("character",G);J.moveEnd("character",C);J.select()}}else{if(this.setSelectionRange){this.setSelectionRange(G,C)}else{if(this.selectionStart){this.selectionStart=G;this.selectionEnd=C}}}})}var E=this[0];if(E.createTextRange){var D=document.selection.createRange(),F=E.value,I="<->",B=D.text.length;D.text=I;var H=E.value.indexOf(I);E.value=F;this.selection(H,H+B);return{start:H,end:H+B}}else{if(E.selectionStart!==undefined){return{start:E.selectionStart,end:E.selectionEnd}}}}})(jQuery);